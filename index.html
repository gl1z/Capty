<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Capty — YouTube Transcript Tool</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@300;400;500;600;700&family=Geist+Mono:wght@400;500&family=Noto+Sans:wght@400;500&family=Noto+Sans+JP:wght@400;500&family=Noto+Sans+SC:wght@400;500&family=Noto+Sans+AR:wght@400;500&display=swap" rel="stylesheet">

    <style>
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            --bg:         #1a1a1e;
            --surface:    #222226;
            --surface-2:  #2a2a2f;
            --border:     #2f2f35;
            --border-2:   #3a3a42;
            --accent:     #ff6b6b;
            --accent-dim: rgba(255, 107, 107, 0.12);
            --text:       #f5f5f7;
            --text-2:     #a1a1aa;
            --text-3:     #52525b;
            --success:    #4ade80;
            --warning:    #fbbf24;
            --radius:     10px;
        }

        html { scroll-behavior: smooth; }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'Geist', sans-serif;
            font-size: 15px;
            line-height: 1.5;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 72px 20px 100px;
            -webkit-font-smoothing: antialiased;
        }

        header {
            text-align: center;
            margin-bottom: 52px;
        }

        .logo {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
        }

        .logo-icon {
            width: 36px;
            height: 36px;
            background: var(--accent);
            border-radius: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-icon svg {
            width: 18px;
            height: 18px;
            fill: #fff;
        }

        .logo-text {
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: -0.5px;
            color: var(--text);
        }

        .tagline {
            font-size: 0.8rem;
            font-weight: 400;
            color: var(--text-3);
            letter-spacing: 0.06em;
            text-transform: uppercase;
        }

        .card {
            width: 100%;
            max-width: 680px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 28px;
        }

        .input-wrap {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        input[type="text"] {
            flex: 1;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            color: var(--text);
            font-family: 'Geist', sans-serif;
            font-size: 0.9rem;
            padding: 11px 14px;
            outline: none;
            transition: border-color 0.18s;
        }

        input[type="text"]:focus {
            border-color: var(--accent);
        }

        input[type="text"]::placeholder {
            color: var(--text-3);
        }

        .btn-primary {
            background: var(--accent);
            color: #fff;
            border: none;
            border-radius: var(--radius);
            font-family: 'Geist', sans-serif;
            font-weight: 600;
            font-size: 0.88rem;
            padding: 11px 22px;
            cursor: pointer;
            transition: opacity 0.15s, transform 0.1s;
            white-space: nowrap;
            letter-spacing: -0.2px;
        }

        .btn-primary:hover  { opacity: 0.88; }
        .btn-primary:active { transform: scale(0.97); }
        .btn-primary:disabled { opacity: 0.35; cursor: not-allowed; transform: none; }

        .lang-row {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-bottom: 18px;
        }

        .lang-btn {
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-2);
            font-family: 'Geist', sans-serif;
            font-size: 0.75rem;
            font-weight: 500;
            padding: 5px 12px;
            cursor: pointer;
            transition: all 0.15s;
            letter-spacing: 0.02em;
        }

        .lang-btn:hover {
            border-color: var(--border-2);
            color: var(--text);
        }

        .lang-btn.active {
            background: var(--accent-dim);
            border-color: var(--accent);
            color: var(--accent);
        }

        .whisper-banner {
            display: none;
            background: var(--surface-2);
            border: 1px solid var(--border-2);
            border-radius: 8px;
            padding: 14px 16px;
            margin-bottom: 18px;
        }

        .whisper-banner p {
            font-size: 0.8rem;
            color: var(--text-2);
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .whisper-banner p strong {
            color: var(--text);
        }

        .btn-whisper {
            background: var(--accent);
            color: #fff;
            border: none;
            border-radius: 7px;
            font-family: 'Geist', sans-serif;
            font-weight: 600;
            font-size: 0.8rem;
            padding: 8px 18px;
            cursor: pointer;
            transition: opacity 0.15s, transform 0.1s;
        }

        .btn-whisper:hover  { opacity: 0.88; }
        .btn-whisper:active { transform: scale(0.97); }
        .btn-whisper:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

        #status {
            display: flex;
            align-items: center;
            gap: 7px;
            font-size: 0.8rem;
            color: var(--text-3);
            min-height: 20px;
            margin-bottom: 16px;
            font-weight: 400;
        }

        #status.err  { color: var(--accent); }
        #status.ok   { color: var(--success); }

        .toolbar {
            display: none;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .meta {
            font-size: 0.75rem;
            color: var(--text-3);
            font-weight: 400;
        }

        .toolbar-actions { display: flex; gap: 6px; }

        .btn-sm {
            background: var(--surface-2);
            border: 1px solid var(--border);
            border-radius: 7px;
            color: var(--text-2);
            font-family: 'Geist', sans-serif;
            font-size: 0.75rem;
            font-weight: 500;
            padding: 5px 13px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .btn-sm:hover {
            border-color: var(--border-2);
            color: var(--text);
        }

        .download-wrap, .translate-wrap {
            position: relative;
        }

        .download-menu, .translate-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 4px;
            background: var(--surface-2);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 4px;
            z-index: 10;
            min-width: 120px;
        }

        .translate-menu {
            min-width: 160px;
            max-height: 240px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--border) transparent;
        }

        .download-menu.show, .translate-menu.show {
            display: block;
        }

        .download-option, .translate-option {
            display: block;
            width: 100%;
            background: none;
            border: none;
            color: var(--text-2);
            font-family: 'Geist', sans-serif;
            font-size: 0.75rem;
            font-weight: 500;
            padding: 7px 12px;
            cursor: pointer;
            text-align: left;
            border-radius: 5px;
            transition: all 0.12s;
        }

        .download-option:hover, .translate-option:hover {
            background: var(--border);
            color: var(--text);
        }

        #output {
            display: none;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            max-height: 460px;
            overflow-y: auto;
            font-family: 'Noto Sans', 'Noto Sans JP', 'Noto Sans SC', 'Noto Sans AR', 'Geist', sans-serif;
            font-size: 0.88rem;
            line-height: 1.85;
            color: var(--text-2);
            white-space: pre-wrap;
            word-break: break-word;
            scrollbar-width: thin;
            scrollbar-color: var(--border) transparent;
        }

        .spinner {
            width: 13px;
            height: 13px;
            border: 2px solid var(--border-2);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.65s linear infinite;
            flex-shrink: 0;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* ── History section ─────────────────────── */
        .history-card {
            width: 100%;
            max-width: 680px;
            margin-top: 20px;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .history-title {
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-3);
            letter-spacing: 0.04em;
            text-transform: uppercase;
        }

        .history-clear {
            background: none;
            border: none;
            color: var(--text-3);
            font-family: 'Geist', sans-serif;
            font-size: 0.7rem;
            cursor: pointer;
            transition: color 0.15s;
        }

        .history-clear:hover {
            color: var(--accent);
        }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .history-item {
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px 16px;
            cursor: pointer;
            transition: border-color 0.15s;
        }

        .history-item:hover {
            border-color: var(--border-2);
        }

        .history-thumb {
            width: 48px;
            height: 36px;
            border-radius: 5px;
            background: var(--surface-2);
            flex-shrink: 0;
            object-fit: cover;
        }

        .history-info {
            flex: 1;
            min-width: 0;
        }

        .history-vid-id {
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .history-date {
            font-size: 0.7rem;
            color: var(--text-3);
        }

        .history-words {
            font-size: 0.7rem;
            color: var(--text-3);
            white-space: nowrap;
        }

        footer {
            margin-top: 36px;
            text-align: center;
            font-size: 0.75rem;
            color: var(--text-3);
        }

        footer a {
            color: var(--text-3);
            text-decoration: none;
            border-bottom: 1px solid var(--border);
            transition: color 0.15s, border-color 0.15s;
        }

        footer a:hover {
            color: var(--text-2);
            border-color: var(--border-2);
        }
    </style>
</head>
<body>

<header>
    <div class="logo">
        <div class="logo-icon">
            <svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                <rect x="2" y="5" width="16" height="2.5" rx="1.25"/>
                <rect x="2" y="9.5" width="11" height="2.5" rx="1.25"/>
                <rect x="2" y="14" width="13" height="2.5" rx="1.25"/>
            </svg>
        </div>
        <span class="logo-text">Capty</span>
    </div>
    <p class="tagline">YouTube transcript, instantly</p>
</header>

<div class="card">

    <div class="input-wrap">
        <input type="text" id="urlInput" placeholder="Paste YouTube URL or video ID…" autocomplete="off" spellcheck="false">
        <button class="btn-primary" id="fetchBtn" onclick="fetchTranscript()">Get transcript</button>
    </div>

    <div class="lang-row" id="langRow"></div>

    <div class="whisper-banner" id="whisperBanner">
        <p><strong>No captions found.</strong> This video has no subtitles — but we can generate a transcript from the audio. This may take up to a minute.</p>
        <button class="btn-whisper" id="whisperBtn" onclick="runWhisper()">Generate transcript</button>
    </div>

    <div id="status"></div>

    <div class="toolbar" id="toolbar">
        <span class="meta" id="metaText"></span>
        <div class="toolbar-actions">
            <button class="btn-sm" onclick="copyText(event)">Copy</button>
            <div class="translate-wrap">
                <button class="btn-sm" id="translateBtn" onclick="toggleTranslateMenu(event)" style="display:none;">Translate ▾</button>
                <div class="translate-menu" id="translateMenu"></div>
            </div>
            <div class="download-wrap">
                <button class="btn-sm" onclick="toggleDownloadMenu(event)">Download ▾</button>
                <div class="download-menu" id="downloadMenu">
                    <button class="download-option" onclick="downloadAs('txt')">.txt</button>
                    <button class="download-option" onclick="downloadAs('pdf')">.pdf</button>
                    <button class="download-option" onclick="downloadAs('docx')">.docx</button>
                </div>
            </div>
        </div>
    </div>

    <div id="output"></div>

</div>

<!-- History section -->
<div class="history-card" id="historyCard" style="display:none;">
    <div class="history-header">
        <span class="history-title">Recent</span>
        <button class="history-clear" onclick="clearHistory()">Clear</button>
    </div>
    <div class="history-list" id="historyList"></div>
</div>

<footer>
    Built by <a href="https://github.com/gl1z" target="_blank">@gl1z</a>
    &nbsp;·&nbsp;
    <a href="https://github.com/gl1z/capty" target="_blank">Source</a>
</footer>

<script>
    // ────────────────────────────────────────────────────────
    // State
    // ────────────────────────────────────────────────────────
    let transcript = '';
    let original   = '';
    let videoId    = '';
    let tracks     = [];
    let langs      = [];
    let translated = false;

    // ────────────────────────────────────────────────────────
    // Helpers
    // ────────────────────────────────────────────────────────
    function parseVideoId(input) {
        input = input.trim();
        const patterns = [
            /(?:youtube\.com\/watch\?.*v=|youtu\.be\/|youtube\.com\/embed\/)([A-Za-z0-9_-]{11})/,
            /^([A-Za-z0-9_-]{11})$/,
        ];
        for (let i = 0; i < patterns.length; i++) {
            const m = input.match(patterns[i]);
            if (m) return m[1];
        }
        return null;
    }

    function setStatus(html, type) {
        const el = document.getElementById('status');
        el.className = type || '';
        el.innerHTML = html;
    }

    function setLoading(msg) {
        setStatus('<div class="spinner"></div><span>' + msg + '</span>');
    }

    function resetUI() {
        document.getElementById('langRow').innerHTML = '';
        document.getElementById('output').style.display = 'none';
        document.getElementById('toolbar').style.display = 'none';
        document.getElementById('whisperBanner').style.display = 'none';
        document.getElementById('translateBtn').style.display = 'none';
        document.getElementById('translateMenu').classList.remove('show');
        document.getElementById('downloadMenu').classList.remove('show');
        translated = false;
    }

    // ────────────────────────────────────────────────────────
    // Display result
    // ────────────────────────────────────────────────────────
    function renderTranscript(text, langOptions) {
        transcript = text;
        original   = text;
        translated = false;

        const wc = text.split(/\s+/).filter(Boolean).length;
        document.getElementById('metaText').textContent = wc.toLocaleString() + ' words';

        const out = document.getElementById('output');
        out.textContent   = text;
        out.style.display = 'block';

        document.getElementById('toolbar').style.display = 'flex';
        setStatus('Done', 'ok');

        if (langOptions && langOptions.length > 0) {
            langs = langOptions;
            buildTranslateMenu(langOptions);
            document.getElementById('translateBtn').style.display = '';
        }

        saveToHistory(videoId, text, wc);
    }

    // ────────────────────────────────────────────────────────
    // Fetch available caption tracks
    // ────────────────────────────────────────────────────────
    function fetchTranscript() {
        const input = document.getElementById('urlInput').value;
        const id    = parseVideoId(input);

        if (!id) {
            setStatus('Paste a valid YouTube URL or video ID.', 'err');
            return;
        }

        videoId = id;
        document.getElementById('fetchBtn').disabled = true;
        resetUI();
        setLoading('Fetching video info…');

        fetch('/api/transcript?id=' + id)
            .then(function(res) { return res.json().then(function(data) { return { ok: res.ok, data: data }; }); })
            .then(function(result) {
                if (!result.ok) throw new Error(result.data.error || 'Something went wrong.');

                tracks = result.data.tracks;

                if (tracks.length === 0 && result.data.whisperAvailable) {
                    setStatus('');
                    document.getElementById('whisperBanner').style.display = 'block';
                    document.getElementById('fetchBtn').disabled = false;
                    return;
                }

                const langRow = document.getElementById('langRow');
                for (let i = 0; i < tracks.length; i++) {
                    (function(idx) {
                        const btn = document.createElement('button');
                        btn.className   = 'lang-btn' + (idx === 0 ? ' active' : '');
                        btn.textContent = tracks[idx].name;
                        btn.onclick     = function() { loadCaption(idx, btn); };
                        langRow.appendChild(btn);
                    })(i);
                }

                loadCaption(0);
            })
            .catch(function(err) {
                setStatus(err.message, 'err');
                document.getElementById('fetchBtn').disabled = false;
            });
    }

    // ────────────────────────────────────────────────────────
    // Load a specific caption track
    // ────────────────────────────────────────────────────────
    function loadCaption(index, btn) {
        if (btn) {
            const all = document.querySelectorAll('.lang-btn');
            for (let i = 0; i < all.length; i++) all[i].classList.remove('active');
            btn.classList.add('active');
        }

        setLoading('Pulling captions…');

        const track = tracks[index];

        fetch('/api/caption?id=' + videoId + '&lang=' + track.languageCode)
            .then(function(res) { return res.json().then(function(data) { return { ok: res.ok, data: data }; }); })
            .then(function(result) {
                if (!result.ok) throw new Error(result.data.error || 'Failed to load transcript.');
                renderTranscript(result.data.text, result.data.translateLangs);
            })
            .catch(function(err) {
                setStatus(err.message + ' — you can try AI transcription instead.', 'err');
                document.getElementById('whisperBanner').style.display = 'block';
            })
            .finally(function() {
                document.getElementById('fetchBtn').disabled = false;
            });
    }

    // ────────────────────────────────────────────────────────
    // Whisper fallback
    // ────────────────────────────────────────────────────────
    function runWhisper() {
        document.getElementById('whisperBtn').disabled = true;
        document.getElementById('whisperBanner').style.display = 'none';
        setLoading('Generating transcript — this can take up to a minute…');

        fetch('/api/whisper', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: videoId }),
        })
            .then(function(res) { return res.json().then(function(data) { return { ok: res.ok, data: data }; }); })
            .then(function(result) {
                if (!result.ok) throw new Error(result.data.error || 'Transcription failed.');
                renderTranscript(result.data.text, result.data.translateLangs);
            })
            .catch(function(err) {
                setStatus(err.message, 'err');
                document.getElementById('whisperBanner').style.display = 'block';
            })
            .finally(function() {
                document.getElementById('whisperBtn').disabled = false;
                document.getElementById('fetchBtn').disabled   = false;
            });
    }

    // ────────────────────────────────────────────────────────
    // Translate
    // ────────────────────────────────────────────────────────
    function buildTranslateMenu(langOptions) {
        const menu = document.getElementById('translateMenu');
        menu.innerHTML = '';

        const origBtn = document.createElement('button');
        origBtn.className     = 'translate-option';
        origBtn.textContent   = '↩ Show original';
        origBtn.id            = 'showOriginalBtn';
        origBtn.style.display = 'none';
        origBtn.onclick = function() {
            transcript = original;
            translated = false;
            document.getElementById('output').textContent = original;
            origBtn.style.display = 'none';
            menu.classList.remove('show');
            const wc = original.split(/\s+/).filter(Boolean).length;
            document.getElementById('metaText').textContent = wc.toLocaleString() + ' words';
            setStatus('Done', 'ok');
        };
        menu.appendChild(origBtn);

        for (let i = 0; i < langOptions.length; i++) {
            (function(lang) {
                const opt = document.createElement('button');
                opt.className   = 'translate-option';
                opt.textContent = lang.name;
                opt.onclick     = function() { translateTo(lang.code, lang.name); };
                menu.appendChild(opt);
            })(langOptions[i]);
        }
    }

    function translateTo(code, name) {
        document.getElementById('translateMenu').classList.remove('show');
        setLoading('Translating to ' + name + '…');

        fetch('/api/translate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text: original, targetLang: code }),
        })
            .then(function(res) { return res.json().then(function(data) { return { ok: res.ok, data: data }; }); })
            .then(function(result) {
                if (!result.ok) throw new Error(result.data.error || 'Translation failed.');

                transcript = result.data.text;
                translated = true;

                document.getElementById('output').textContent = result.data.text;

                const wc = result.data.text.split(/\s+/).filter(Boolean).length;
                document.getElementById('metaText').textContent = wc.toLocaleString() + ' words · ' + name;

                const origBtn = document.getElementById('showOriginalBtn');
                if (origBtn) origBtn.style.display = '';

                setStatus('Translated to ' + name, 'ok');
            })
            .catch(function(err) {
                setStatus(err.message, 'err');
            });
    }

    function toggleTranslateMenu(e) {
        e.stopPropagation();
        document.getElementById('downloadMenu').classList.remove('show');
        document.getElementById('translateMenu').classList.toggle('show');
    }

    // ────────────────────────────────────────────────────────
    // Copy
    // ────────────────────────────────────────────────────────
    function copyText(e) {
        navigator.clipboard.writeText(transcript).then(function() {
            const btn  = e ? e.target : document.querySelector('.btn-sm');
            const prev = btn.textContent;
            btn.textContent = 'Copied!';
            setTimeout(function() { btn.textContent = prev; }, 1600);
        });
    }

    // ────────────────────────────────────────────────────────
    // Download
    // ────────────────────────────────────────────────────────
    function toggleDownloadMenu(e) {
        e.stopPropagation();
        document.getElementById('translateMenu').classList.remove('show');
        document.getElementById('downloadMenu').classList.toggle('show');
    }

    document.addEventListener('click', function() {
        document.getElementById('downloadMenu').classList.remove('show');
        document.getElementById('translateMenu').classList.remove('show');
    });

    function downloadAs(format) {
        document.getElementById('downloadMenu').classList.remove('show');
        const filename = 'capty-' + videoId;

        if (format === 'txt') {
            const blob = new Blob([transcript], { type: 'text/plain' });
            downloadBlob(blob, filename + '.txt');
        }

        if (format === 'pdf') {
            const win = window.open('', '_blank');
            win.document.write(
                '<html><head><title>' + filename + '</title>' +
                '<style>body{font-family:"Segoe UI","Noto Sans",Arial,sans-serif;font-size:13px;line-height:1.8;padding:40px;color:#222;max-width:700px}' +
                'h1{font-size:16px;color:#666;margin-bottom:20px;border-bottom:1px solid #ddd;padding-bottom:10px}</style>' +
                '</head><body><h1>Capty Transcript — ' + videoId + '</h1>' +
                '<p>' + transcript.replace(/\n/g, '<br>') + '</p></body></html>'
            );
            win.document.close();
            setTimeout(function() { win.print(); }, 400);
        }

        if (format === 'docx') {
            const paragraphs = transcript.split(/\n+/);
            const xmlParts = [];
            for (let i = 0; i < paragraphs.length; i++) {
                const safe = paragraphs[i].replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                xmlParts.push('<w:p><w:r><w:rPr><w:sz w:val="22"/></w:rPr><w:t xml:space="preserve">' + safe + '</w:t></w:r></w:p>');
            }
            const docContent =
                '<?xml version="1.0" encoding="UTF-8" standalone="yes"?>' +
                '<w:document xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main"><w:body>' +
                '<w:p><w:r><w:rPr><w:b/><w:sz w:val="28"/></w:rPr><w:t>Capty Transcript — ' + videoId + '</w:t></w:r></w:p>' +
                '<w:p><w:r><w:t></w:t></w:r></w:p>' +
                xmlParts.join('') +
                '</w:body></w:document>';
            const blob = new Blob([docContent], { type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' });
            downloadBlob(blob, filename + '.doc');
        }
    }

    function downloadBlob(blob, name) {
        const a = document.createElement('a');
        a.href     = URL.createObjectURL(blob);
        a.download = name;
        a.click();
        URL.revokeObjectURL(a.href);
    }

    // ────────────────────────────────────────────────────────
    // History
    // ────────────────────────────────────────────────────────
    const STORAGE_KEY    = 'capty_history';
    const HISTORY_LIMIT  = 10;

    function getHistory() {
        try {
            const raw = localStorage.getItem(STORAGE_KEY);
            return raw ? JSON.parse(raw) : [];
        } catch (e) {
            return [];
        }
    }

    function saveToHistory(id, text, wc) {
        let history = getHistory();

        history = history.filter(function(item) { return item.id !== id; });

        history.unshift({
            id: id,
            words: wc,
            date: new Date().toISOString(),
            preview: text.slice(0, 120),
        });

        if (history.length > HISTORY_LIMIT) {
            history = history.slice(0, HISTORY_LIMIT);
        }

        localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
        renderHistory();
    }

    function renderHistory() {
        const history = getHistory();
        const card    = document.getElementById('historyCard');
        const list    = document.getElementById('historyList');

        if (history.length === 0) {
            card.style.display = 'none';
            return;
        }

        card.style.display = 'block';
        list.innerHTML = '';

        for (let i = 0; i < history.length; i++) {
            (function(item) {
                const row = document.createElement('div');
                row.className = 'history-item';
                row.onclick = function() {
                    document.getElementById('urlInput').value = item.id;
                    fetchTranscript();
                };

                const thumb = document.createElement('img');
                thumb.className = 'history-thumb';
                thumb.src = 'https://i.ytimg.com/vi/' + item.id + '/default.jpg';
                thumb.alt = '';
                thumb.loading = 'lazy';

                const info = document.createElement('div');
                info.className = 'history-info';

                const title = document.createElement('div');
                title.className   = 'history-vid-id';
                title.textContent = item.id;

                const date = document.createElement('div');
                date.className   = 'history-date';
                const d = new Date(item.date);
                date.textContent = d.toLocaleDateString();

                info.appendChild(title);
                info.appendChild(date);

                const words = document.createElement('span');
                words.className   = 'history-words';
                words.textContent = item.words.toLocaleString() + ' words';

                row.appendChild(thumb);
                row.appendChild(info);
                row.appendChild(words);
                list.appendChild(row);
            })(history[i]);
        }
    }

    function clearHistory() {
        localStorage.removeItem(STORAGE_KEY);
        renderHistory();
    }

    // ────────────────────────────────────────────────────────
    // Init
    // ────────────────────────────────────────────────────────
    document.getElementById('urlInput').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') fetchTranscript();
    });

    renderHistory();
</script>

</body>
</html>